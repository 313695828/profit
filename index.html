<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>利润计算器</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#165DFF',
            secondary: '#36CFC9',
            accent: '#722ED1',
            weekend: '#FFE5E5', // 周末高亮颜色
            neutral: {
              100: '#F2F3F5',
              200: '#E5E6EB',
              300: '#C9CDD4',
              400: '#86909C',
              500: '#4E5969',
              600: '#272E3B',
              700: '#1D2129',
            },
            success: '#00B42A',
            warning: '#FF7D00',
            danger: '#F53F3F',
          },
          fontFamily: {
            inter: ['Inter', 'sans-serif'],
          },
        },
      }
    }
  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .shadow-soft {
        box-shadow: 0 2px 14px 0 rgba(0, 0, 0, 0.06);
      }
      .card-hover {
        transition: all 0.3s ease;
      }
      .card-hover:hover {
        transform: translateY(-4px);
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      }
      .gradient-bg {
        background: linear-gradient(135deg, #165DFF 0%, #722ED1 100%);
      }
      .text-gradient {
        background-clip: text;
        -webkit-background-clip: text;
        color: transparent;
        background-image: linear-gradient(135deg, #165DFF 0%, #722ED1 100%);
      }
    }
  </style>
</head>
<body class="font-inter bg-neutral-100 text-neutral-700 min-h-screen flex flex-col">
  <!-- 导航栏 -->
  <nav class="bg-white shadow-md sticky top-0 z-50 transition-all duration-300">
    <div class="container mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center space-x-2">
        <div class="w-10 h-10 rounded-lg gradient-bg flex items-center justify-center">
          <i class="fa fa-calendar-check-o text-white text-xl"></i>
        </div>
        <h1 class="text-xl font-bold text-neutral-700">利润计算器</h1>
      </div>
      
      <div class="hidden md:flex items-center space-x-6">
        <a href="#" class="text-primary font-medium hover:text-primary/80 transition-colors">首页</a>
        <a href="#" class="text-neutral-500 font-medium hover:text-primary transition-colors">历史记录</a>
        <a href="#" class="text-neutral-500 font-medium hover:text-primary transition-colors">帮助</a>
      </div>
      
      <div class="md:hidden">
        <button class="text-neutral-700 focus:outline-none">
          <i class="fa fa-bars text-xl"></i>
        </button>
      </div>
    </div>
  </nav>

  <!-- 主要内容 -->
  <main class="flex-grow container mx-auto px-4 py-8">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- 左侧表单 -->
      <div class="lg:col-span-1">
        <div class="bg-white rounded-xl shadow-soft p-6 card-hover">
          <h2 class="text-xl font-bold mb-4 flex items-center">
            <i class="fa fa-plus-circle text-primary mr-2"></i>添加项目
          </h2>
          
          <form id="profitForm" class="space-y-4">
            <div>
              <label for="projectName" class="block text-sm font-medium text-neutral-500 mb-1">项目名称</label>
              <input type="text" id="projectName" name="projectName" 
                class="w-full px-4 py-2 border border-neutral-200 rounded-lg focus:ring-2 focus:ring-primary/30 focus:border-primary outline-none transition-all"
                placeholder="例如：31天新疆小红杏">
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label for="days" class="block text-sm font-medium text-neutral-500 mb-1">天数</label>
                <input type="number" id="days" name="days" min="1" 
                  class="w-full px-4 py-2 border border-neutral-200 rounded-lg focus:ring-2 focus:ring-primary/30 focus:border-primary outline-none transition-all"
                  placeholder="输入天数" oninput="calculateDueDate()">
              </div>
              
              <div>
                <label for="copies" class="block text-sm font-medium text-neutral-500 mb-1">份数</label>
                <input type="number" id="copies" name="copies" min="1" 
                  class="w-full px-4 py-2 border border-neutral-200 rounded-lg focus:ring-2 focus:ring-primary/30 focus:border-primary outline-none transition-all"
                  placeholder="输入份数">
              </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label for="profitPerCopy" class="block text-sm font-medium text-neutral-500 mb-1">每份利润</label>
                <div class="relative">
                  <span class="absolute left-3 top-1/2 -translate-y-1/2 text-neutral-400">¥</span>
                  <input type="number" id="profitPerCopy" name="profitPerCopy" step="0.01" min="0" 
                    class="w-full pl-8 pr-4 py-2 border border-neutral-200 rounded-lg focus:ring-2 focus:ring-primary/30 focus:border-primary outline-none transition-all"
                    placeholder="输入每份利润">
                </div>
              </div>
              
              <div>
                <label for="totalProfit" class="block text-sm font-medium text-neutral-500 mb-1">总利润</label>
                <div class="relative">
                  <span class="absolute left-3 top-1/2 -translate-y-1/2 text-neutral-400">¥</span>
                  <input type="number" id="totalProfit" name="totalProfit" step="0.01" min="0" 
                    class="w-full pl-8 pr-4 py-2 border border-neutral-200 rounded-lg focus:ring-2 focus:ring-primary/30 focus:border-primary outline-none transition-all"
                    placeholder="输入总利润" readonly>
                </div>
              </div>
            </div>
            
            <div>
              <label for="bankCard" class="block text-sm font-medium text-neutral-500 mb-1">付款银行卡</label>
              <input type="text" id="bankCard" name="bankCard" 
                class="w-full px-4 py-2 border border-neutral-200 rounded-lg focus:ring-2 focus:ring-primary/30 focus:border-primary outline-none transition-all"
                placeholder="例如：农业银行">
            </div>
            
            <div>
              <label for="dueDate" class="block text-sm font-medium text-neutral-500 mb-1">到期日期</label>
              <input type="date" id="dueDate" name="dueDate" 
                class="w-full px-4 py-2 border border-neutral-200 rounded-lg focus:ring-2 focus:ring-primary/30 focus:border-primary outline-none transition-all"
                readonly>
            </div>
            
            <div>
              <label for="cost" class="block text-sm font-medium text-neutral-500 mb-1">成本</label>
              <div class="relative">
                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-neutral-400">¥</span>
                <input type="number" id="cost" name="cost" step="0.01" min="0" 
                  class="w-full pl-8 pr-4 py-2 border border-neutral-200 rounded-lg focus:ring-2 focus:ring-primary/30 focus:border-primary outline-none transition-all"
                  placeholder="输入成本">
              </div>
            </div>
            
            <div class="pt-2">
              <button type="button" id="calculateBtn" 
                class="w-full bg-primary hover:bg-primary/90 text-white font-medium py-2 px-4 rounded-lg transition-all flex items-center justify-center">
                <i class="fa fa-calculator mr-2"></i>计算利润率
              </button>
            </div>
            
            <div class="pt-2">
              <button type="button" id="addBtn" 
                class="w-full bg-success hover:bg-success/90 text-white font-medium py-2 px-4 rounded-lg transition-all flex items-center justify-center">
                <i class="fa fa-plus mr-2"></i>添加到表格
              </button>
            </div>
          </form>
        </div>
        
        <!-- 利润率卡片 -->
        <div class="mt-6 bg-white rounded-xl shadow-soft p-6 card-hover">
          <h2 class="text-xl font-bold mb-4 flex items-center">
            <i class="fa fa-line-chart text-primary mr-2"></i>利润率分析
          </h2>
          
          <div class="space-y-4">
            <div class="bg-neutral-50 rounded-lg p-4">
              <div class="flex justify-between items-center mb-2">
                <span class="text-neutral-500">平均日利润率</span>
                <span class="font-bold" id="avgDailyProfitRate">0.00%</span>
              </div>
              <div class="w-full bg-neutral-200 rounded-full h-2">
                <div id="dailyRateBar" class="bg-primary h-2 rounded-full" style="width: 0%"></div>
              </div>
            </div>
            
            <div class="bg-neutral-50 rounded-lg p-4">
              <div class="flex justify-between items-center mb-2">
                <span class="text-neutral-500">年化利润率</span>
                <span class="font-bold" id="annualProfitRate">0.00%</span>
              </div>
              <div class="w-full bg-neutral-200 rounded-full h-2">
                <div id="annualRateBar" class="bg-secondary h-2 rounded-full" style="width: 0%"></div>
              </div>
            </div>
            
            <div class="bg-neutral-50 rounded-lg p-4">
              <div class="flex justify-between items-center mb-2">
                <span class="text-neutral-500">总利润</span>
                <div class="flex items-center">
                  <span class="font-bold mr-1">¥</span>
                  <span class="font-bold" id="totalProfitSum">0.00</span>
                </div>
              </div>
              <div class="w-full bg-neutral-200 rounded-full h-2">
                <div id="profitSumBar" class="bg-accent h-2 rounded-full" style="width: 0%"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- 右侧表格和图表 -->
      <div class="lg:col-span-2 space-y-6">
        <!-- 表格卡片 -->
        <div class="bg-white rounded-xl shadow-soft p-6 card-hover">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold flex items-center">
              <i class="fa fa-table text-primary mr-2"></i>项目列表
            </h2>
            <div class="flex space-x-2">
              <button id="exportBtn" class="bg-neutral-100 hover:bg-neutral-200 text-neutral-700 font-medium py-1.5 px-3 rounded-lg transition-all flex items-center">
                <i class="fa fa-download mr-1"></i>导出
              </button>
              <button id="clearBtn" class="bg-neutral-100 hover:bg-neutral-200 text-neutral-700 font-medium py-1.5 px-3 rounded-lg transition-all flex items-center">
                <i class="fa fa-trash mr-1"></i>清空
              </button>
            </div>
          </div>
          
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-neutral-200">
              <thead class="bg-neutral-50">
                <tr>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider">项目名称</th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider">天数</th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider">份数</th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider">每份利润</th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider">总利润</th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider">付款银行卡</th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider">到期日期</th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider">成本</th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider">年化利润率</th>
                  <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-neutral-500 uppercase tracking-wider">操作</th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-neutral-200" id="projectsTable">
                <!-- 表格内容将通过JavaScript动态添加 -->
                <tr class="text-center">
                  <td colspan="10" class="px-6 py-12 text-neutral-400">
                    <div class="flex flex-col items-center">
                      <i class="fa fa-folder-open-o text-4xl mb-3"></i>
                      <p>暂无数据</p>
                      <p class="text-xs mt-1">请添加项目以查看数据</p>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        
        <!-- 图表卡片 -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="bg-white rounded-xl shadow-soft p-6 card-hover">
            <h2 class="text-xl font-bold mb-4 flex items-center">
              <i class="fa fa-pie-chart text-primary mr-2"></i>利润分布
            </h2>
            <div class="h-64">
              <canvas id="profitDistributionChart"></canvas>
            </div>
          </div>
          
          <div class="bg-white rounded-xl shadow-soft p-6 card-hover">
            <h2 class="text-xl font-bold mb-4 flex items-center">
              <i class="fa fa-bar-chart text-primary mr-2"></i>利润率对比
            </h2>
            <div class="h-64">
              <canvas id="profitRateComparisonChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- 页脚 -->
  <footer class="bg-white border-t border-neutral-200 py-6 mt-8">
    <div class="container mx-auto px-4">
      <div class="flex flex-col md:flex-row justify-between items-center">
        <div class="mb-4 md:mb-0">
          <p class="text-neutral-500 text-sm">© 2025 利润计算器. 保留所有权利.</p>
        </div>
        <div class="flex space-x-4">
          <a href="#" class="text-neutral-400 hover:text-primary transition-colors">
            <i class="fa fa-github text-lg"></i>
          </a>
          <a href="#" class="text-neutral-400 hover:text-primary transition-colors">
            <i class="fa fa-twitter text-lg"></i>
          </a>
          <a href="#" class="text-neutral-400 hover:text-primary transition-colors">
            <i class="fa fa-linkedin text-lg"></i>
          </a>
        </div>
      </div>
    </div>
  </footer>

  <!-- 添加项目模态框 -->
  <div id="projectModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
    <div class="bg-white rounded-xl shadow-lg max-w-md w-full mx-4 transform transition-all">
      <div class="p-6 border-b border-neutral-200">
        <h3 class="text-lg font-bold">项目详情</h3>
      </div>
      <div class="p-6 space-y-4">
        <div>
          <label class="block text-sm font-medium text-neutral-500 mb-1">项目名称</label>
          <p id="modalProjectName" class="text-neutral-700"></p>
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-neutral-500 mb-1">天数</label>
            <p id="modalDays" class="text-neutral-700"></p>
          </div>
          <div>
            <label class="block text-sm font-medium text-neutral-500 mb-1">份数</label>
            <p id="modalCopies" class="text-neutral-700"></p>
          </div>
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-neutral-500 mb-1">每份利润</label>
            <p id="modalProfitPerCopy" class="text-neutral-700"></p>
          </div>
          <div>
            <label class="block text-sm font-medium text-neutral-500 mb-1">总利润</label>
            <p id="modalTotalProfit" class="text-neutral-700"></p>
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-neutral-500 mb-1">付款银行卡</label>
          <p id="modalBankCard" class="text-neutral-700"></p>
        </div>
        <div>
          <label class="block text-sm font-medium text-neutral-500 mb-1">到期日期</label>
          <p id="modalDueDate" class="text-neutral-700"></p>
        </div>
        <div>
          <label class="block text-sm font-medium text-neutral-500 mb-1">成本</label>
          <p id="modalCost" class="text-neutral-700"></p>
        </div>
        <div>
          <label class="block text-sm font-medium text-neutral-500 mb-1">年化利润率</label>
          <p id="modalAnnualRate" class="text-neutral-700"></p>
        </div>
      </div>
      <div class="p-6 border-t border-neutral-200 flex justify-end">
        <button id="closeModalBtn" class="bg-primary hover:bg-primary/90 text-white font-medium py-2 px-4 rounded-lg transition-all">
          关闭
        </button>
      </div>
    </div>
  </div>

  <script>
    // 存储项目数据
    let projects = [];
    
    // DOM元素
    const profitForm = document.getElementById('profitForm');
    const projectNameInput = document.getElementById('projectName');
    const daysInput = document.getElementById('days');
    const copiesInput = document.getElementById('copies');
    const profitPerCopyInput = document.getElementById('profitPerCopy');
    const totalProfitInput = document.getElementById('totalProfit');
    const bankCardInput = document.getElementById('bankCard');
    const dueDateInput = document.getElementById('dueDate');
    const costInput = document.getElementById('cost');
    const calculateBtn = document.getElementById('calculateBtn');
    const addBtn = document.getElementById('addBtn');
    const projectsTable = document.getElementById('projectsTable');
    const exportBtn = document.getElementById('exportBtn');
    const clearBtn = document.getElementById('clearBtn');
    const avgDailyProfitRate = document.getElementById('avgDailyProfitRate');
    const annualProfitRate = document.getElementById('annualProfitRate');
    const totalProfitSum = document.getElementById('totalProfitSum');
    const dailyRateBar = document.getElementById('dailyRateBar');
    const annualRateBar = document.getElementById('annualRateBar');
    const profitSumBar = document.getElementById('profitSumBar');
    const projectModal = document.getElementById('projectModal');
    const closeModalBtn = document.getElementById('closeModalBtn');
    
    // 初始化图表
    let profitDistributionChart;
    let profitRateComparisonChart;
    
    // 计算总利润
    function calculateTotalProfit() {
      const copies = parseFloat(copiesInput.value) || 0;
      const profitPerCopy = parseFloat(profitPerCopyInput.value) || 0;
      const totalProfit = copies * profitPerCopy;
      
      totalProfitInput.value = totalProfit.toFixed(2);
      return totalProfit;
    }
    
    // 计算到期日期
    function calculateDueDate() {
      const days = parseInt(daysInput.value) || 0;
      if (days <= 0) {
        dueDateInput.value = '';
        return;
      }
      
      const today = new Date();
      const dueDate = new Date(today);
      dueDate.setDate(today.getDate() + days);
      
      // 格式化为YYYY-MM-DD
      const year = dueDate.getFullYear();
      const month = String(dueDate.getMonth() + 1).padStart(2, '0');
      const day = String(dueDate.getDate()).padStart(2, '0');
      
      dueDateInput.value = `${year}-${month}-${day}`;
    }
    
    // 计算年化利润率
    function calculateAnnualProfitRate(days, profit, cost) {
      if (days <= 0 || cost <= 0) return 0;
      
      // 年化利润率 = (利润/天数/成本)*365*100%
      return (profit / days / cost) * 365 * 100;
    }
    
    // 格式化货币
    function formatCurrency(value) {
      return value.toLocaleString('zh-CN', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });
    }
    
    // 格式化百分比
    function formatPercentage(value) {
      return value.toFixed(2) + '%';
    }
    
    // 将数字星期转换为中文
    function getWeekdayName(weekdayNum) {
      const weekdays = ['周日', '周一', '周二', '周三', '周四', '周五', '周六'];
      return weekdays[weekdayNum];
    }
    
    // 判断是否为周末
    function isWeekend(weekdayNum) {
      return weekdayNum === 0 || weekdayNum === 6;
    }
    
    // 更新项目表格
    function updateProjectsTable() {
      if (projects.length === 0) {
        projectsTable.innerHTML = `
          <tr class="text-center">
            <td colspan="10" class="px-6 py-12 text-neutral-400">
              <div class="flex flex-col items-center">
                <i class="fa fa-folder-open-o text-4xl mb-3"></i>
                <p>暂无数据</p>
                <p class="text-xs mt-1">请添加项目以查看数据</p>
              </div>
            </td>
          </tr>
        `;
        updateCharts();
        updateSummary();
        return;
      }
      
      let html = '';
      
      projects.forEach((project, index) => {
        const annualRate = calculateAnnualProfitRate(project.days, project.totalProfit, project.cost);
        const annualRateFormatted = formatPercentage(annualRate);
        
        // 解析到期日期为星期几
        const date = new Date(project.dueDate);
        const weekdayNum = date.getDay();
        const weekdayName = getWeekdayName(weekdayNum);
        const isWeekendDay = isWeekend(weekdayNum);
        
        // 确定利润率颜色
        let rateColorClass = 'text-success';
        if (annualRate < 5) rateColorClass = 'text-neutral-500';
        if (annualRate >= 15) rateColorClass = 'text-accent';
        
        // 确定到期日期样式
        let dateCellStyle = '';
        if (isWeekendDay) {
          dateCellStyle = 'bg-weekend text-danger font-medium';
        }
        
        html += `
          <tr class="hover:bg-neutral-50 transition-colors">
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="flex items-center">
                <div class="w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center mr-3">
                  <i class="fa fa-cube text-primary"></i>
                </div>
                <div>
                  <div class="font-medium text-neutral-700">${project.name}</div>
                </div>
              </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">${project.days}</td>
            <td class="px-6 py-4 whitespace-nowrap">${project.copies}</td>
            <td class="px-6 py-4 whitespace-nowrap">¥${formatCurrency(project.profitPerCopy)}</td>
            <td class="px-6 py-4 whitespace-nowrap font-medium">¥${formatCurrency(project.totalProfit)}</td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="flex items-center">
                <i class="fa fa-credit-card text-neutral-400 mr-2"></i>
                ${project.bankCard}
              </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap ${dateCellStyle}">
              ${project.dueDate} (${weekdayName})
            </td>
            <td class="px-6 py-4 whitespace-nowrap">¥${formatCurrency(project.cost)}</td>
            <td class="px-6 py-4 whitespace-nowrap ${rateColorClass}">${annualRateFormatted}</td>
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
              <button onclick="viewProject(${index})" class="text-primary hover:text-primary/80 mr-3">
                <i class="fa fa-eye"></i>
              </button>
              <button onclick="editProject(${index})" class="text-neutral-500 hover:text-neutral-700 mr-3">
                <i class="fa fa-pencil"></i>
              </button>
              <button onclick="deleteProject(${index})" class="text-danger hover:text-danger/80">
                <i class="fa fa-trash"></i>
              </button>
            </td>
          </tr>
        `;
      });
      
      projectsTable.innerHTML = html;
      updateCharts();
      updateSummary();
    }
    
    // 更新统计摘要
    function updateSummary() {
      if (projects.length === 0) {
        avgDailyProfitRate.textContent = '0.00%';
        annualProfitRate.textContent = '0.00%';
        totalProfitSum.textContent = '0.00';
        dailyRateBar.style.width = '0%';
        annualRateBar.style.width = '0%';
        profitSumBar.style.width = '0%';
        return;
      }
      
      let totalDays = 0;
      let totalProfit = 0;
      let totalCost = 0;
      
      projects.forEach(project => {
        totalDays += project.days;
        totalProfit += project.totalProfit;
        totalCost += project.cost;
      });
      
      // 计算平均日利润率
      const avgDailyProfit = totalProfit / totalDays;
      const avgDailyProfitRateValue = (avgDailyProfit / totalCost) * 100;
      
      // 计算总年化利润率
      const totalAnnualProfitRate = calculateAnnualProfitRate(totalDays, totalProfit, totalCost);
      
      // 更新DOM
      avgDailyProfitRate.textContent = formatPercentage(avgDailyProfitRateValue);
      annualProfitRate.textContent = formatPercentage(totalAnnualProfitRate);
      totalProfitSum.textContent = formatCurrency(totalProfit);
      
      // 更新进度条
      dailyRateBar.style.width = `${Math.min(avgDailyProfitRateValue * 5, 100)}%`;
      annualRateBar.style.width = `${Math.min(totalAnnualProfitRate * 2, 100)}%`;
      profitSumBar.style.width = `${Math.min(totalProfit / 1000 * 20, 100)}%`;
    }
    
    // 更新图表
    function updateCharts() {
      if (projects.length === 0) {
        if (profitDistributionChart) profitDistributionChart.destroy();
        if (profitRateComparisonChart) profitRateComparisonChart.destroy();
        return;
      }
      
      // 准备利润分布图表数据
      const profitLabels = projects.map(project => project.name);
      const profitData = projects.map(project => project.totalProfit);
      const profitColors = projects.map((_, index) => {
        const hue = 210 - (index * 30) % 360;
        return `hsla(${hue}, 100%, 60%, 0.7)`;
      });
      
      // 创建或更新利润分布图表
      if (!profitDistributionChart) {
        const ctx1 = document.getElementById('profitDistributionChart').getContext('2d');
        profitDistributionChart = new Chart(ctx1, {
          type: 'doughnut',
          data: {
            labels: profitLabels,
            datasets: [{
              data: profitData,
              backgroundColor: profitColors,
              borderWidth: 0,
              hoverOffset: 4
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'bottom',
                labels: {
                  usePointStyle: true,
                  padding: 20,
                  font: {
                    family: 'Inter',
                    size: 11
                  }
                }
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    const label = context.label || '';
                    const value = context.raw || 0;
                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                    const percentage = Math.round((value / total) * 100);
                    return `${label}: ¥${formatCurrency(value)} (${percentage}%)`;
                  }
                }
              }
            },
            cutout: '70%'
          }
        });
      } else {
        profitDistributionChart.data.labels = profitLabels;
        profitDistributionChart.data.datasets[0].data = profitData;
        profitDistributionChart.data.datasets[0].backgroundColor = profitColors;
        profitDistributionChart.update();
      }
      
      // 准备利润率对比图表数据
      const rateLabels = projects.map(project => project.name);
      const rateData = projects.map(project => 
        calculateAnnualProfitRate(project.days, project.totalProfit, project.cost)
      );
      const rateColors = rateData.map(rate => {
        if (rate < 5) return 'hsla(210, 14%, 53%, 0.7)';
        if (rate >= 15) return 'hsla(271, 76%, 53%, 0.7)';
        return 'hsla(177, 70%, 49%, 0.7)';
      });
      
      // 创建或更新利润率对比图表
      if (!profitRateComparisonChart) {
        const ctx2 = document.getElementById('profitRateComparisonChart').getContext('2d');
        profitRateComparisonChart = new Chart(ctx2, {
          type: 'bar',
          data: {
            labels: rateLabels,
            datasets: [{
              label: '年化利润率 (%)',
              data: rateData,
              backgroundColor: rateColors,
              borderRadius: 6,
              barThickness: 12
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    return `年化利润率: ${formatPercentage(context.raw)}`;
                  }
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                grid: {
                  display: true,
                  color: 'rgba(0, 0, 0, 0.05)'
                },
                ticks: {
                  font: {
                    family: 'Inter'
                  }
                }
              },
              x: {
                grid: {
                  display: false
                },
                ticks: {
                  font: {
                    family: 'Inter'
                  }
                }
              }
            }
          }
        });
      } else {
        profitRateComparisonChart.data.labels = rateLabels;
        profitRateComparisonChart.data.datasets[0].data = rateData;
        profitRateComparisonChart.data.datasets[0].backgroundColor = rateColors;
        profitRateComparisonChart.update();
      }
    }
    
    // 添加项目
    function addProject() {
      const name = projectNameInput.value.trim();
      const days = parseInt(daysInput.value) || 0;
      const copies = parseInt(copiesInput.value) || 0;
      const profitPerCopy = parseFloat(profitPerCopyInput.value) || 0;
      const totalProfit = parseFloat(totalProfitInput.value) || 0;
      const bankCard = bankCardInput.value.trim();
      const dueDate = dueDateInput.value || '未设置';
      const cost = parseFloat(costInput.value) || 0;
      
      if (!name || days <= 0 || copies <= 0 || profitPerCopy <= 0 || cost <= 0) {
        alert('请填写完整且有效的项目信息！');
        return;
      }
      
      // 添加项目到数组
      projects.push({
        name,
        days,
        copies,
        profitPerCopy,
        totalProfit,
        bankCard,
        dueDate,
        cost
      });
      
      // 保存到本地存储
      localStorage.setItem('profitProjects', JSON.stringify(projects));
      
      // 更新表格
      updateProjectsTable();
      
      // 清空表单
      profitForm.reset();
      
      // 显示成功提示
      showToast('项目添加成功！');
    }
    
    // 编辑项目
    function editProject(index) {
      const project = projects[index];
      if (!project) return;
      
      // 填充表单
      projectNameInput.value = project.name;
      daysInput.value = project.days;
      copiesInput.value = project.copies;
      profitPerCopyInput.value = project.profitPerCopy;
      totalProfitInput.value = project.totalProfit;
      bankCardInput.value = project.bankCard;
      dueDateInput.value = project.dueDate;
      costInput.value = project.cost;
      
      // 删除原项目
      projects.splice(index, 1);
      
      // 更新表格
      updateProjectsTable();
    }
    
    // 删除项目
    function deleteProject(index) {
      if (confirm('确定要删除这个项目吗？')) {
        projects.splice(index, 1);
        
        // 更新本地存储
        localStorage.setItem('profitProjects', JSON.stringify(projects));
        
        // 更新表格
        updateProjectsTable();
        
        // 显示成功提示
        showToast('项目已删除！');
      }
    }
    
    // 查看项目详情
    function viewProject(index) {
      const project = projects[index];
      if (!project) return;
      
      const annualRate = calculateAnnualProfitRate(project.days, project.totalProfit, project.cost);
      
      // 解析到期日期为星期几
      const date = new Date(project.dueDate);
      const weekdayNum = date.getDay();
      const weekdayName = getWeekdayName(weekdayNum);
      
      // 填充模态框
      document.getElementById('modalProjectName').textContent = project.name;
      document.getElementById('modalDays').textContent = project.days;
      document.getElementById('modalCopies').textContent = project.copies;
      document.getElementById('modalProfitPerCopy').textContent = `¥${formatCurrency(project.profitPerCopy)}`;
      document.getElementById('modalTotalProfit').textContent = `¥${formatCurrency(project.totalProfit)}`;
      document.getElementById('modalBankCard').textContent = project.bankCard;
      document.getElementById('modalDueDate').textContent = `${project.dueDate} (${weekdayName})`;
      document.getElementById('modalCost').textContent = `¥${formatCurrency(project.cost)}`;
      document.getElementById('modalAnnualRate').textContent = formatPercentage(annualRate);
      
      // 显示模态框
      projectModal.classList.remove('hidden');
    }
    
    // 导出数据
    function exportData() {
      if (projects.length === 0) {
        alert('没有数据可导出！');
        return;
      }
      
      // 创建CSV内容
      let csvContent = "项目名称,天数,份数,每份利润,总利润,付款银行卡,到期日期,成本,年化利润率\n";
      
      projects.forEach(project => {
        const annualRate = calculateAnnualProfitRate(project.days, project.totalProfit, project.cost);
        csvContent += `${project.name},${project.days},${project.copies},${project.profitPerCopy},${project.totalProfit},${project.bankCard},${project.dueDate},${project.cost},${annualRate.toFixed(2)}%\n`;
      });
      
      // 创建下载链接
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.setAttribute('href', url);
      link.setAttribute('download', `利润数据_${new Date().toISOString().slice(0,10)}.csv`);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      // 显示成功提示
      showToast('数据导出成功！');
    }
    
    // 清空所有数据
    function clearAllData() {
      if (confirm('确定要清空所有项目数据吗？此操作不可恢复！')) {
        projects = [];
        localStorage.removeItem('profitProjects');
        updateProjectsTable();
        
        // 显示成功提示
        showToast('所有数据已清空！');
      }
    }
    
    // 显示提示框
    function showToast(message) {
      // 创建提示元素
      const toast = document.createElement('div');
      toast.className = 'fixed bottom-6 right-6 bg-neutral-800 text-white px-6 py-3 rounded-lg shadow-lg transform transition-all duration-300 opacity-0 translate-y-4 z-50 flex items-center';
      toast.innerHTML = `
        <i class="fa fa-check-circle mr-2"></i>
        <span>${message}</span>
      `;
      
      // 添加到页面
      document.body.appendChild(toast);
      
      // 显示动画
      setTimeout(() => {
        toast.classList.remove('opacity-0', 'translate-y-4');
      }, 10);
      
      // 3秒后隐藏
      setTimeout(() => {
        toast.classList.add('opacity-0', 'translate-y-4');
        setTimeout(() => {
          document.body.removeChild(toast);
        }, 300);
      }, 3000);
    }
    
    // 从本地存储加载数据
    function loadData() {
      const savedProjects = localStorage.getItem('profitProjects');
      if (savedProjects) {
        projects = JSON.parse(savedProjects);
        updateProjectsTable();
      }
    }
    
    // 事件监听
    document.addEventListener('DOMContentLoaded', () => {
      // 加载本地存储数据
      loadData();
      
      // 计算总利润
      copiesInput.addEventListener('input', calculateTotalProfit);
      profitPerCopyInput.addEventListener('input', calculateTotalProfit);
      
      // 计算到期日期
      daysInput.addEventListener('input', calculateDueDate);
      
      // 计算利润率
      calculateBtn.addEventListener('click', () => {
        const days = parseInt(daysInput.value) || 0;
        const totalProfit = parseFloat(totalProfitInput.value) || 0;
        const cost = parseFloat(costInput.value) || 0;
        
        if (days <= 0 || totalProfit <= 0 || cost <= 0) {
          alert('请填写完整的天数、总利润和成本！');
          return;
        }
        
        const annualRate = calculateAnnualProfitRate(days, totalProfit, cost);
        
        // 显示提示
        showToast(`年化利润率: ${formatPercentage(annualRate)}`);
      });
      
      // 添加项目
      addBtn.addEventListener('click', addProject);
      
      // 导出数据
      exportBtn.addEventListener('click', exportData);
      
      // 清空数据
      clearBtn.addEventListener('click', clearAllData);
      
      // 关闭模态框
      closeModalBtn.addEventListener('click', () => {
        projectModal.classList.add('hidden');
      });
      
      // 点击模态框外部关闭
      projectModal.addEventListener('click', (e) => {
        if (e.target === projectModal) {
          projectModal.classList.add('hidden');
        }
      });
      
      // 为表格添加动画效果
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            entry.target.classList.add('animate-fadeIn');
            observer.unobserve(entry.target);
          }
        });
      }, { threshold: 0.1 });
      
      if (projectsTable) {
        observer.observe(projectsTable);
      }
    });
    
    // 使函数全局可用
    window.viewProject = viewProject;
    window.editProject = editProject;
    window.deleteProject = deleteProject;
  </script>
</body>
</html>
